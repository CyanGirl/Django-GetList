from django.shortcuts import render
from bs4 import BeautifulSoup
import requests
from requests.compat import quote_plus
from . import models

# Create your views here.

base_url = 'https://kolkata.craigslist.org/search/?query={}'
BASE_IMAGE_URL = 'https://images.craigslist.org/{}_300x300.jpg'


def home(request):
    return render(request, "myapp/base.html")


def newSearch(request):

    # retreiving the data from the front end by "name"
    search = request.POST.get("search")
    # saving the search query to database
    models.Search.objects.create(search=search)

    final_url = base_url.format(quote_plus(search))
    # now getting the response from the server
    response = requests.get(final_url)
    data = response.text
    # prettify
    soup = BeautifulSoup(data, features="html.parser")
    # find all links
    posts = soup.find_all("li", {"class": "result-row"})

    final_posts = []
    for post in posts:
        post_title = post.find(class_="result-title").text
        post_url = post.find("a").get("href")
        if post.find(class_="result-price"):
            post_price = post.find(class_="result-price").text
        else:
            post_price = "N/A"

        if post.find(class_='result-image').get('data-ids'):
            post_image_id = post.find(
                class_='result-image').get('data-ids').split(',')[0].split(':')[1]
            post_image_url = BASE_IMAGE_URL.format(post_image_id)

        else:
            post_image_url = 'data:image/jpeg;base64,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'

        final_posts.append((post_title, post_url, post_price, post_image_url))

    context = {"search": search, "final_posts": final_posts, }
    return render(request, "myapp/newSearch.html", context)
